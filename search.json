[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Mire trenching indicator",
    "section": "",
    "text": "1 Background and aims\nIn order to describe the ecological condition of wetland, an inclusion of hydrology is essential. Still, there are no operational ecosystem condition indicators that adequately describe the hydrological status of wetlands in Norway.\nIn Norway, trenching in order to lower the water table of mires has been widely conducted for centuries, and systematically conducted for about 150 years, most commonly in order to facilitate the cultivation of crops or trees. Today, the creation of new trenches is not allowed, yet the scars of old and also more recently made or maintained trenches are evident in the landscape. Many of the trenched ares have changed from open wetlands into forest or agriculture.\nThere are no official maps of mire trenches in Norway. In order to make such a map, Vegar Bakkestuen and colleagues did a pilot study to see if they could identify trenches from LiDAR (Jansson et al. 2024). After annotating ground-trouthed data from several regions in Norway, they trained a deep-learning algorithm to estimate the probability of the occurrence of trenches. The model was applied to a number of smaller study areas in Norway. The results were promising, and efforts are underway to scale up this model and predict mire trenches across Norway.\nThe trenching map provides a probability for the occurrence of trenches in 1x1 m grid cells. Although the deep learning model is trained on trenches in mires, forests and swamp forests, the map identifies trenches across whole landscapes, including trenches in agricultural areas, road ditches, etc.\nThis projects goal is to develop a concept for how a forthcomming national trenching map can be used to characterize the hydrological status of mires in Norway though the use of a normative indicator. Some of the requirements for such an indicator include having area-representative data (i.e.¬†wall-to-wall data or balanced on key environmental variables), and the ability to regularly update the indicator values based on new information. It is also recommended that indicators are based on open data and source code.\n\n\n\n\nJansson, U., Bakkestuen, V., Lyngstad, A., and Mienna, I.M. 2024. Utvikling av gr√∏ftekart i myr og torvmark i norge med hjelp av dypl√¶ring.",
    "crumbs": [
      "<span class='chapter-number'>1</span>¬† <span class='chapter-title'>Background and aims</span>"
    ]
  },
  {
    "objectID": "study-area.html",
    "href": "study-area.html",
    "title": "2¬† Study area and trenching data",
    "section": "",
    "text": "2.1 Adding AR5\nThe open wetlands, shown as red areas in Figure¬†2.2, are largely laying outside of the systematically trenched areas. This can be because the trenched areas, which may have been open mire to begin with, now are overgrown with trees. The map of open mires is in way trained to find areas that are not trenched, so no wonder if the ecosystem condition looks good in these areas. Instead I think we should include forested mires in the Ecosystem Type (ET). We can use the mire class in the AR5 maps in addition to the open mires map. AR5 underestimates the total mire area, but it probably includes more forested mires. Another alternative would be to use the new Ecosystem Map of Norway (Strand et al. 2023), but this uses AR50, i.e.¬†as coarser generalization of AR5.\nRead AR5 and plotar5 &lt;- readRDS(\"data/ar5.rds\")\nggplot() + \n  geom_sf(data = ar5,\n          aes(fill = Arealtype)) +\n  geom_sf(data = lev_crop,\n          fill = \"yellow\",\n          color = \"yellow\")\n\n\n\n\n\n\nFigure¬†2.3: ‚ÄúAR5 overlayed with the mire trenches data. AR5 classifies most of the systamtically trenched peatlands as mire, and some as forest.\nLet‚Äôs separate out the areas that are mire in AR5, but not in the open mire map, and see if adding these areas make a difference. Of coarse, we are only looking at a very small spatial extent here, and it is not representative for all the differences between AR5 and the opne mire map, but still.\nFilter data# make the ecosystem delineation map into polygons\nmire &lt;- st_as_sf(mire10_crop, merge = T)\nmire_gg &lt;- ggplot(data = mire)+\n  geom_sf(fill = \"blue\")+\n  labs(title = \"Open mire model\")\n\n# Filter out the mire part of AR5\nar5_myr &lt;- ar5 |&gt;\n  filter(Arealtype == \"Myr\") |&gt;\n  st_cast(\"POLYGON\")\nar5_myr_gg &lt;- ggplot(data = ar5_myr)+\n  geom_sf(fill = \"cyan4\")+\n  labs(title = \"AR5\")\n\n# Take out the open mire part of AR5 (leaving the forested peatlands)\nst_erase = function(x, y) st_difference(x, st_union(st_combine(y)))\nar5_nonOpen &lt;- ar5_myr |&gt;\n  st_erase(mire)\n\n# Take out the AR5 part of the open mire model\nonly_open &lt;- mire |&gt;\n  st_erase(ar5_myr) |&gt;\n  st_cast(\"MULTIPOLYGON\") |&gt;\n  st_cast(\"POLYGON\")\n\nonly_open_gg &lt;- ggplot(data = only_open)+\n  geom_sf(fill = \"purple\")+\n  labs(title = \"Open mires not in AR5\")\n\nar5_nonOpen_gg &lt;- \n  ggplot(data = ar5_nonOpen)+\n  geom_sf(fill = \"orange\")+\n  labs(title = \"AR5 minus open mires\")\n\n# check that polygons dont overlap\ncheck &lt;- \n  ggplot(data = ar5_nonOpen)+\n  geom_sf(fill = \"red\",\n          alpha=.5)+\n  geom_sf(data = mire,\n          fill = \"blue\",\n          alpha=.5)+\n  labs(title = \"AR5 (red) and open mires\\n (blue) combined\")\n\n# combine into new mire map\n# This first attempt with st_union produces way to many small polygon\n#peatlands &lt;- ar5_myr |&gt;\n#  st_union(mire) |&gt;\n#  st_cast(\"MULTIPOLYGON\") |&gt;\n#  st_cast(\"POLYGON\")\n\n#but this works:\npeatlands &lt;- ar5_myr |&gt;\n  st_join(mire) |&gt;\n  st_intersection()\n\npeatlands_gg &lt;- ggplot(data = peatlands)+\n  geom_sf(fill = \"green\")+\n  labs(title = \"AR5 + open mires\")\nPlot dataggarrange(mire_gg, \n          ar5_myr_gg, \n          ar5_nonOpen_gg, \n          only_open_gg,\n          check, \n          peatlands_gg,\n          ncol=2, nrow=3)\n\n\n\n\n\n\nFigure¬†2.4: ‚ÄúDifferent combinations of the open mire model and the AR5 mire category.‚Äù",
    "crumbs": [
      "<span class='chapter-number'>2</span>¬† <span class='chapter-title'>Study area and trenching data</span>"
    ]
  },
  {
    "objectID": "delineation.html",
    "href": "delineation.html",
    "title": "3¬† Delineation",
    "section": "",
    "text": "3.1 The importance of the ecosystem accounting area\nWe presented a study area that is practically square (Figure¬†2.1). However, for the purpose of an ecosystem condition account or assessment, this area needs to be partitioned into unique and non-overlapping ecosystems, and our indicator needs to address the ecosystem condition the target ecosystem explicitly. The ecosystem that this indicator is aimed at is wetlands, or v√•tmark in Norwegian.\nWe might therefore need to mask our spatial data at some stage in order to exclude trenches identified in other ecosystems. However, this is problematic for several reasons.\nFirst, we do not have an official ecosystem delineation map, and it is not yet clear if the ecosystem should be defined as all types of wetlands, or just open wetlands. In the case of the latter, we have a quite good ecosystem map that we can use (Figure¬†2.2). Alternatively, we can use things like AR5, or a combination of the two.\nSecondly, by excluding everything that is no (open) mire, we automatically exclude wetlands, or previous wetlands, that have become forested due to the lowered water table that comes from trenching. In other words, we exclude the areas that are in the worst condition. From Figure¬†2.2 we can see that this is a very common scenario.\nThirdly, when it comes to updating the indicator in the future (see Chapter 5), we will be in the case that more and more trenched wetland becomes classified as other nature types, mainly forests, because that is what happends when you trench a mire. As a consequence, the indicator values will look better and better over time, reflection the land use change and the associated loss of the areas in worst condition.\nThis is a well known issue in ecosystem accounting (ref Jacobson).\nWe may chose to\nThe third option is perhaps not ideal due to significant model errors, for example that the trenches map includes road ditches, agricultural drainage ditches, and ditches in mountains or other areas that have never been wetlands.\nThe first option is the one that best fit the accounting standards. The suggested way to overcome the false message that wetlands may develop better ecosystem condition just because the worst areas become classified as forests, is to always look at the condition assessment in light of, and at the same time as, an ecosystem extent account. Then the loss of wetland area will still make red flags, even though it is documented in the extent account and not the condition account.\nIt can be very tempting to go for option 2, but as you can see, the consequent double-counting of the same process then becomes unavoidable. We will therefore go for option 1 here, using the open mire delineation map as our ecosystem assets. However, in the future, if the target ecosystem becomes defined as to include forested mires, then it is not a problem to update this indicator to include such areas as well.",
    "crumbs": [
      "<span class='chapter-number'>3</span>¬† <span class='chapter-title'>Delineation</span>"
    ]
  },
  {
    "objectID": "delineation.html#the-importance-of-the-ecosystem-accounting-area",
    "href": "delineation.html#the-importance-of-the-ecosystem-accounting-area",
    "title": "3¬† Delineation",
    "section": "",
    "text": "strictly follow the UN standard for ecosystem accounting and only focus on the open mires (and/or AR5 mires).\nmask the data against both mires and forests\nno masking, calculating the variable for all areas regardless of nature type",
    "crumbs": [
      "<span class='chapter-number'>3</span>¬† <span class='chapter-title'>Delineation</span>"
    ]
  },
  {
    "objectID": "metrics.html",
    "href": "metrics.html",
    "title": "4¬† Possible metrics",
    "section": "",
    "text": "4.1 Frequency-based metrics\nThe frequency of trenches can be measured in many ways and at many different scales. One way is to use the method described for NiN variable 7TK (Rune Halvorsen and Harald Bratli 2019). This approach consists of gridding the entire study region into 10ùñ∑10 m cells, and then categorizing the cells as having or not having trenches. The frequency of grid cells with trenches determines the variable value. There is a worked example of this in Chapter 6.\nThe upper and lower reference values for the variable may be defined using the natural value of 0% and 100%, respectively. However, the rescaling of the variable into an indicator should probably follow some non-linear function, potentially aided by a threshold value representing the value of the variable that defines the separation distinction good and bad ecosystem condition (ref). Expert opinion, possibly aided by real word data or visual aids such as areal photos of areas with different variable value, could be used to set this threshold value.\nA different option for a frequency-based metric include counting the proportion of mire units (e.g.¬†hydrological units) that are affected by trenching. This approach require that we know the population of mire units, or that we have a good, balanced sample of such units, to base our metric on. We do not have this currently. Secondly, the metric, as is it described here, becomes quite sensible to errors in the trenching model, and would probably require setting some (arbitrary) threshold value for the severity of trenching on each mire unit.",
    "crumbs": [
      "<span class='chapter-number'>4</span>¬† <span class='chapter-title'>Possible metrics</span>"
    ]
  },
  {
    "objectID": "metrics.html#length-based-metrics",
    "href": "metrics.html#length-based-metrics",
    "title": "4¬† Possible metrics",
    "section": "4.2 Length based metrics",
    "text": "4.2 Length based metrics\nAs describes earlier, the length of trenches, and therefore also the accumulated length for any given area, may be approximated by using half the circumference of the trenching polygons (minus some small penalty). This metric is very simple and easily interpretable. The metric is also ecologically relevant, as the length of trenches is probably among the metrices that best explain the impact of trenching on the landscape (in combination with the depth of the trenches, but this is not something we have data on currently).\nThe upper reference value must be defined as 0 m of trenches. The lower reference value is not obvious, nor the threshold value. These could be defined using expert opinion, as described for Section 4.1.\n\n4.2.1 Area-based metric\nThe area affected by trenching can perhaps be estimated by adding a buffer on the trenching polygons. The area affected by trenching as a proportion of the total mire area is a nice and simple concept for an indicator. The challenge is how to define the buffer. 10 m buffers have been used in the past. However, the size of the effect from a trench decreases non-linearly from the center of the ditch, and the length of the effect zone will depend a lot on the local typography. Ditches at the bottom of sloping mires will be more effective at draining water from the mire than a trench located near the top. Perhaps information about sloe could be included in the calculation of buffer widths?",
    "crumbs": [
      "<span class='chapter-number'>4</span>¬† <span class='chapter-title'>Possible metrics</span>"
    ]
  },
  {
    "objectID": "metrics.html#scalability",
    "href": "metrics.html#scalability",
    "title": "4¬† Possible metrics",
    "section": "4.3 Scalability",
    "text": "4.3 Scalability\nThe metric chosen to inform the indicator on trenching should idealy be scalable, meaning it can be calculated or interpreted at different scale. The indicator might be useful for regional assessment of wetland condition, as well as in local or project scale assessment, for example in association with environmental impact assessments for new building projects.\nI believe the three methods describe above all all scalable and could be used at local scales as well as regional scale (which is the main focus here).\n\n\n\n\nRune Halvorsen, and Harald Bratli. 2019. Dokumentasjon av NiN versjon 2.2 tilrettelagt for praktisk naturkartlegging: Utvalgte variabler fra beskrivelsessystemet.  natur i norge, artikkel 11 (versjon 2.2.0).",
    "crumbs": [
      "<span class='chapter-number'>4</span>¬† <span class='chapter-title'>Possible metrics</span>"
    ]
  },
  {
    "objectID": "how-to-update.html#footnotes",
    "href": "how-to-update.html#footnotes",
    "title": "5¬† Options for updating the trenching indicator",
    "section": "",
    "text": "https://services.arcgis.com/2JlC1JM9VNKvqb4F/arcgis/rest/services/Myrrestaurering_Groft_Torvtak_3_visning/FeatureServer‚Ü©Ô∏é",
    "crumbs": [
      "<span class='chapter-number'>5</span>¬† <span class='chapter-title'>Options for updating the trenching indicator</span>"
    ]
  },
  {
    "objectID": "7TK.html",
    "href": "7TK.html",
    "title": "6¬† Frequency-based metric",
    "section": "",
    "text": "6.1 Including forest peatlands\nNow let‚Äôs calculate the indicator value based on the orange areas (the third map) and the green areas (the last map) in Figure¬†2.4, and see if it looks very different what we had.\nCalculate indicator values for non-open mires in AR5grid100_freq3 &lt;- trench_in_cell10 |&gt;\n  st_intersection(ar5_nonOpen) |&gt;\n  st_drop_geometry() |&gt;\n  group_by(id10) |&gt;\n  summarise(n = n()) |&gt;\n  ungroup() |&gt;\n  add_column(trenched = 1) |&gt;\n  select(-n) |&gt;\n  right_join(grid10, by = \"id10\") |&gt;\n  mutate(trenched = case_when(\n    is.na(trenched) ~ 0,\n    .default = trenched\n  )) |&gt;\n  st_as_sf() |&gt;\n  st_intersection(ar5_nonOpen) |&gt;\n  st_drop_geometry() |&gt;\n  group_by(id) |&gt;\n  summarise(freq = mean(trenched)*100) |&gt;\n  right_join(grid100, by = \"id\") |&gt;\n  st_as_sf() |&gt;\n  st_intersection(ar5_nonOpen)\n\ngrid100_freq3 &lt;- grid100_freq3 |&gt;\n  mutate(indicator = \n           ea_normalise(\n  data = grid100_freq3,\n  vector = \"freq\",\n  upper_reference_level = 50,\n  lower_reference_level = 0,\n  break_point = 10,\n  scaling_function = \"sigmoid\",\n  reverse=T,\n  plot = F))\n\ngrid100_freq3 |&gt;\n  ggplot() +\n  geom_sf(aes(fill = indicator))+\n  theme_bw() +\n  geom_sf(data = trench_in_cell)+\n  scale_fill_gradient(\n    \"Indicator value\", \n    low = high, \n    high = low)\n\n\n\n\n\n\nFigure¬†6.8: ‚ÄúIndicator values over non-open AR5 mires only‚Äù\nFigure¬†6.8 is a lot more red than Figure¬†6.7!\nCalculate indicator values for non-open miregrid100_freq3 &lt;- grid100_freq3 |&gt;\n  mutate(area = st_area(sf..st_make_grid.lev_crop..cellsize...100.))\n\nind_dist_nonopen &lt;- NULL\nfor(i in 1:1000){\n  ind_dist_nonopen[i] &lt;- \n    mean(sample(grid100_freq3$indicator, \n       nrow(grid100_freq3),\n       replace = TRUE,\n       prob = grid100_freq3$area))\n}\n\n#ind_dist_nonopen |&gt;\n#  as_tibble() |&gt;\n#  ggplot()+\n#  geom_density(aes(x = value),\n#    fill = \"burlywood\") +\n#  labs(x = \"Indicator value\")\nLet‚Äôs do the same, but include all AR5 mires, and the little bit extra areas from the open mire map.\nCalculate indicator values for open and non-open miresgrid100_freq4 &lt;- trench_in_cell10 |&gt;\n  st_intersection(peatlands) |&gt;\n  st_drop_geometry() |&gt;\n  group_by(id10) |&gt;\n  summarise(n = n()) |&gt;\n  ungroup() |&gt;\n  add_column(trenched = 1) |&gt;\n  select(-n) |&gt;\n  right_join(grid10, by = \"id10\") |&gt;\n  mutate(trenched = case_when(\n    is.na(trenched) ~ 0,\n    .default = trenched\n  )) |&gt;\n  st_as_sf() |&gt;\n  st_intersection(peatlands) |&gt;\n  st_drop_geometry() |&gt;\n  group_by(id) |&gt;\n  summarise(freq = mean(trenched)*100) |&gt;\n  right_join(grid100, by = \"id\") |&gt;\n  st_as_sf() |&gt;\n  st_intersection(peatlands)\n\ngrid100_freq4 &lt;- grid100_freq4 |&gt;\n  mutate(indicator = \n           ea_normalise(\n  data = grid100_freq4,\n  vector = \"freq\",\n  upper_reference_level = 50,\n  lower_reference_level = 0,\n  break_point = 10,\n  scaling_function = \"sigmoid\",\n  reverse=T,\n  plot = F))\n\n# Option to have uniform class:\ngrid100_freq4 &lt;- grid100_freq4 |&gt;\n  st_cast(\"MULTIPOLYGON\") |&gt;\n  st_cast(\"POLYGON\")\n\n#saveRDS(grid100_freq4, \"data/grid100_freq4.rds\")\n\ngrid100_freq4 |&gt;\n  ggplot() +\n  geom_sf(aes(fill = indicator))+\n  theme_bw() +\n  geom_sf(data = trench_in_cell)+\n  scale_fill_gradient(\n    \"Indicator value\", \n    low = high, \n    high = low)\n\n\n\n\n\n\nFigure¬†6.9: ‚ÄúIndicator values over all peatlands (AR5 + the open mire model)‚Äù\nCalculate indicator values for all miresgrid100_freq4 &lt;- grid100_freq4 |&gt;\n  mutate(area = st_area(sf..st_make_grid.lev_crop..cellsize...100.))\n\nind_dist_all &lt;- NULL\nfor(i in 1:1000){\n  ind_dist_all[i] &lt;- \n    mean(sample(grid100_freq4$indicator, \n       nrow(grid100_freq4),\n       replace = TRUE,\n       prob = grid100_freq4$area))\n}\n\nind_dist_comb &lt;- tibble(\n  open = ind_dist_open,\n  forested = ind_dist_nonopen,\n  all = ind_dist_all\n) |&gt;\n  pivot_longer(\n    cols = everything(),\n    names_to = \"extent\",\n    values_to = \"indicator_value\")\nMake ridge plotind_dist_comb |&gt;\n  ggplot(\n    aes(\n      x = indicator_value, \n      y = extent,\n      fill = after_stat(x))\n  ) +\n  geom_density_ridges_gradient(\n    bandwidth=.005,\n    quantile_lines = TRUE, \n    quantiles = c(0.025, .5, 0.975)\n  ) +\n  scale_fill_distiller(palette = \"RdYlGn\",\n    direction = 1) +\n  theme_bw(base_size = 15) +\n  guides(fill = \"none\") +\n  geom_vline(xintercept = .6,\n    size=1.2,\n    lty=2) +\n  theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1))+\n  labs(y = \"\", x = \"Indicator values\")+\n  xlim(c(0,1)\n)\n\n\n\n\n\n\nFigure¬†6.10: ‚ÄúIndicator values (distributions from bootstrapping) for the mire trenching indicator cacualted for a small test area and using three different ecosystem delineation maps. Vertical lines are 2.5, 50 and 97.5 percentiles.‚Äù\nFigure¬†6.10 shows us that the ecosystem delineation makes a huge difference on the indicator values. Combining AR5 and the open mire model gives a mean indicator value of 0.54, reflection quite predictably the rather binary situation in Figure¬†6.9 where half the area is dark red and the other half is green.\nI think it makes most sense to combine AR5 and the open mire model for this indicator. But all indicators used in the same assessment must use the same ecosystem delineation. And if this AR5+open mire combination is not agreeable, then using AR5, alternatively the new Ecosystem Map of Norway (Strand et al. 2023), would be preferable to using just the open mire model.",
    "crumbs": [
      "<span class='chapter-number'>6</span>¬† <span class='chapter-title'>Frequency-based metric</span>"
    ]
  },
  {
    "objectID": "7TK.html#including-forest-peatlands",
    "href": "7TK.html#including-forest-peatlands",
    "title": "6¬† Frequency-based metric",
    "section": "",
    "text": "Strand, G.-H., Framstad, E., and Opsahl, L.A. 2023. Hoved√∏kosystemkart for norge. NIBIO Rapport.",
    "crumbs": [
      "<span class='chapter-number'>6</span>¬† <span class='chapter-title'>Frequency-based metric</span>"
    ]
  },
  {
    "objectID": "calibration.html",
    "href": "calibration.html",
    "title": "7¬† Setting reference levels",
    "section": "",
    "text": "Up to this point I used reference levels (RL) drawn from my own personal and subjective intuition. There might be more objective ways to do this, or at least more precise and defendable ways. What we have decided on is to create a set of calibration maps, with varying amounts of trenching, and then several experts will look at these and judge individually how severe they believe a given density of trenches will be for the mire ecosystem. We need (minimum) three RLs. We define our RL based on the 7GR-GI variable in Halvorsen and Bratli (2019).\nThere is no way for us to know the ages of the trenches in our data. Therefore it is impossible to separate the realised from the future effects from trenching. We therefore combine these two aspects, and describe the ecosystem effect of trenching based on the future equilibrium state that will result as a consequence of the trenching that has happened. This approach is not ideal, and the ecosystem condition should preferably be describes as a snap shot of the condition as it is today. However, we see know other solution to this issue.\nX0 is the variable value (i.e.¬†the frequency of 10x10 grid cells with trenching inside each 100x100 cell) that corresponds to a completely destroyed ecosystem. A further deterioration of the variable value should now result in any further deterioration of ecosystem condition. We have defined this as a 7GR-GI value of 5, meaning that the ecosystem is set on a succession towards a non-wetland type, usually forest.\nX100 is the RL at the reference condition (RC; pristine condition in our case). This RL is quite intuitive and is set to zero (7GR-GI = 1). Note that the trenches data has been filtered to remove very small polygons that are more likely to be artefacts than real trenches.\nX60 represents the variable value at the boundary between good and deteriorated ecosystem condition. We have decided to anchor this RL theoretically to the point where trenching is so severe that the species composition in the mire ecosystem has changes so much as to correspond to a one-step change along one of the dominant environmental gradient (LKMs; Halvorsen and Bratli (2019)). This equates to 7GR-GI = 3.\n7GR-GI is meant to be describes for whole hydrological units, but here we instead use it for individual grid cells. This means that a grid cell can be described as having no trenching, and this a favorable indicator value, even though the mire as a whole is severely affected by trenching arising from neighboring grid cells. This implies that our indicator could en dup to be to conservative. However, we think the size of our grid cells (100x100m) is a relevant scale for describing trenching effects, that are known to often extend tens of meters from a large trench, but rarely hundreds of meters.\nTo set the RLs for our variable, we could potentially use empirical data, such as nature type mapping data where mire polygons are assign 7GR-GI values in the field. However, this field protocol does not include mapping of more common mire types, and although our study areas is mapped using this protocol, no mire polygons have been delineated.\nRather than using empirical data, we decided to use a kind of structured expert eliciation based on a common consensus. Our expert panel consisted of five ecologist with extensive and relevant field experience. First we agreed on the theoretical definition of the RLs (se above). Then we looked at a set of 100x100m grid cells with varying densities of trenches (@fig-calplots) and together we discussed and reached a consensus about which variable values to map to the different RLs.\n\nSet up Google API, download and save satelite images# I used this to save the API key to my syst env\n# ggmap::register_google(key = \"\", write = TRUE)\n\n# example of getting sat imagae for the entire area\n# get center coordinate\ne &lt;- st_as_sfc(st_bbox(grid100_freq4)) |&gt;\n  st_transform(4326) |&gt;\n  st_centroid() |&gt;\n  st_coordinates() |&gt;\n  as.numeric()\nnames(e) &lt;- c(\"lon\", \"lat\")\n  \nsatImg &lt;- ggmap:: get_googlemap(\n  center = e, \n  zoom = 14,\n  maptype = \"satellite\"\n  )\n#ggmap(satImg)\n#saveRDS(satImg, \"data/satImg.rds\")\n\n\n\nGet some grid cells with varying amount of trenching# Transform to 4326 to match ggmap objects\ncells &lt;- grid100_freq4 |&gt;\n  # requre at least half a grid cell\n  filter(area &gt; set_units(5000, m2)) |&gt;\n  mutate(tens = round(freq, -1)) |&gt;\n  group_by(tens) |&gt;\n  slice_max(freq, \n    n = 2,\n    with_ties = F) |&gt;\n  ungroup() |&gt;\n  st_transform(4326)\n  \ncells_c &lt;- cells |&gt;\n  st_centroid() |&gt;\n  st_coordinates() |&gt;\n  as_tibble() |&gt;\n  rename(\"lon\" = \"X\", \"lat\" = \"Y\") \ncells &lt;- cells |&gt;\n  bind_cols(cells_c)\n\n\n\nFunction for downloading static google mapmyGgmap &lt;- function(x, zoom = 18){\n  ggmap:: get_googlemap(\n  center = c(lon = x$lon, lat = x$lat), \n  zoom = zoom,\n  maptype = \"satellite\"\n  )\n}\n\n\n# Hackish function to fix bbox in the ggmap object\n# https://stackoverflow.com/questions/47749078/how-to-put-a-geom-sf-produced-map-on-top-of-a-ggmap-produced-raster\nggmap_bbox &lt;- function(map) {\n  if (!inherits(map, \"ggmap\")) stop(\"map must be a ggmap object\")\n  # Extract the bounding box (in lat/lon) from the ggmap to a numeric vector, \n  # and set the names to what sf::st_bbox expects:\n  map_bbox &lt;- setNames(unlist(attr(map, \"bb\")), \n                       c(\"ymin\", \"xmin\", \"ymax\", \"xmax\"))\n\n  # Coonvert the bbox to an sf polygon, transform it to 3857, \n  # and convert back to a bbox (convoluted, but it works)\n  bbox_3857 &lt;- st_bbox(st_transform(st_as_sfc(st_bbox(map_bbox, crs = 4326)), 3857))\n\n  # Overwrite the bbox of the ggmap object with the transformed coordinates \n  attr(map, \"bb\")$ll.lat &lt;- bbox_3857[\"ymin\"]\n  attr(map, \"bb\")$ll.lon &lt;- bbox_3857[\"xmin\"]\n  attr(map, \"bb\")$ur.lat &lt;- bbox_3857[\"ymax\"]\n  attr(map, \"bb\")$ur.lon &lt;- bbox_3857[\"xmax\"]\n  map\n}\n\n\n\nLoop though and get sat image for each grid cellsatimg &lt;- list(NULL)\nfor(i in 1:nrow(cells)){\n  satimg[[i]] &lt;- ggmap_bbox(myGgmap(cells[i,]))\n}\nsaveRDS(satimg, \"data/satImg.rds\")\n\n\n\nRead cachesatimg &lt;- readRDS(\"data/satImg.rds\")\n\n\n\nLoop through and make maps# convert grid cell df to 3857\ncells2 &lt;- st_transform(cells, 3857)\nlev_crop2 &lt;- st_transform(lev_crop, 3857)\n\nfor (i in 1:nrow(cells2)) {\n  dat &lt;- cells2[i, ]\n\n  suppressMessages(\n  without &lt;- ggmap(ggmap = satimg[[i]]) +\n    coord_sf(crs = st_crs(3857)) +\n    geom_sf(\n      data = dat,\n      inherit.aes = F,\n      fill = NA,\n      color = \"yellow\",\n      size = 2\n    )\n  )\n  \n  suppressMessages(\n  with &lt;- ggmap(ggmap = satimg[[i]])+\n  coord_sf(crs = st_crs(3857))+\n  geom_sf(data = dat, \n          inherit.aes = F,\n          fill = NA,\n          color = \"yellow\",\n          size=2) +\n  geom_sf(data = lev_crop,\n          inherit.aes = F,\n          fill = \"orange\",\n          color = \"orange\") +\n  ggtitle(paste(\"Trenching frequency = \", round(dat$freq, 1),\"%\"))\n  )\n\n  assign(\n    x = paste0(\"ID\", dat$id),\n    ggarrange(with, without)\n  )\n  \n}\n\n\n\nShow mapsfor(i in 1:nrow(cells)){\n  p &lt;- get(paste0(\"ID\", cells$id[i]))\n  print(p)\n}\n\n\n\n\n\n\nFigure¬†7.1\n\n\n\n\n\n\n\n\n\nFigure¬†7.2\n\n\n\n\n\n\n\n\n\nFigure¬†7.3\n\n\n\n\n\n\n\n\n\nFigure¬†7.4\n\n\n\n\n\n\n\n\n\nFigure¬†7.5\n\n\n\n\n\n\n\n\n\nFigure¬†7.6\n\n\n\n\n\n\n\n\n\nFigure¬†7.7\n\n\n\n\n\n\n\n\n\nFigure¬†7.8\n\n\n\n\n\n\n\n\n\nFigure¬†7.9\n\n\n\n\n\n\n\n\n\nFigure¬†7.10\n\n\n\n\n\n\n\n\n\nFigure¬†7.11\n\n\n\n\n\n\n\n\n\nFigure¬†7.12\n\n\n\n\n\n\n\n\n\nFigure¬†7.13\n\n\n\n\n\n\n\n\n\nFigure¬†7.14\n\n\n\n\n\n\n\n\n\nFigure¬†7.15\n\n\n\n\n\n\n\n\n\nFigure¬†7.16\n\n\n\n\n\n\n\n\n\nFigure¬†7.17\n\n\n\n\n\n\n\n\n\nFigure¬†7.18\n\n\n\n\n\n\n\n\n\nFigure¬†7.19\n\n\n\n\n\n\n\n\n\nFigure¬†7.20\n\n\n\n\n\n\n\n\nHalvorsen, R., and Bratli, H. 2019. Dokumentasjon av NiN versjon 2.2 tilrettelagt for praktisk naturkartlegging: Utvalgte variabler fra beskrivelsessystemet.  natur i norge, artikkel 11 (versjon 2.2.0).",
    "crumbs": [
      "<span class='chapter-number'>7</span>¬† <span class='chapter-title'>Setting reference levels</span>"
    ]
  }
]