# Study area and trenching data {#sec-area}

In this project we will use data from Levanger in central Norway. This area was part of the pilot study to identify mire trenches in Norway based on LiDAR (see @sec-background).

```{r setup}
#| warning: false
#| error: false
#| include: false
library(sf)
library(tidyverse)
library(basemaps)
library(stars)
options(scipen = 999)
```

```{r data}
#| code-fold: true
#| code-summary: "Read shape file and convert to gpkg" 
#| eval: false

path <- "P:/41201785_okologisk_tilstand_2022_2023/data/grofter/Kolstad"
lev <- sf::read_sf(paste0(path, "/LevangerGroftPolygon.shp")) |>
  sf::st_make_valid()
lev |> sf::st_write("data/lev.gpkg")
```

```{r data2}
#| code-fold: true
#| code-summary: "Read data"
lev <- sf::read_sf("data/lev.gpkg")
```

```{r stats}
#| code-fold: true
#| code-summary: "Calculate study extent"

lev_bb <- sf::st_bbox(lev)
myx <- unname(round(lev_bb["xmax"] - lev_bb["xmin"]))
myy <- unname(round(lev_bb["ymax"] - lev_bb["ymin"]))
```

The study area is `r myx` ùñ∑ `r myy` meters, or `r round(myx*myy/10^6)` km^2^.

```{r basemapSetup}
#| code-fold: true
#| code-summary: "Set up basemap"

basemaps::set_defaults(map_service = "osm", map_type = "topographic")
lev_t <- lev |>
  st_transform(3857)
```

```{r fig-map1}
#| code-fold: true
#| code-summary: "Make map"
#| fig-cap: |
#|   "Map of study area in Levanger, central Norway, showing trenched mires i purple. 
#|   Note that the colored polygon borders exagerrate the area of the trenches."
#| cache: true
#| message: false

ggplot() + 
  basemap_gglayer(sf::st_bbox(lev_t)) +
  scale_fill_identity() + 
  coord_sf() +
  geom_sf(data = lev_t,
          fill = "purple",
          color = "purple") +
  theme_bw()
```

Let's zoom in on an area just north of Tomtvatnet, and overlay the trenches data with the best map that we have on the presence of open mires.

```{r zoombbox}
#| code-fold: true
#| code-summary: "Creat new bbox"
#| warning: false

bbox_new <- st_bbox(lev) # current bounding box

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

bbox_new[1] <- bbox_new[1] + (0.3 * xrange) # xmin - left
bbox_new[3] <- bbox_new[3] - (0.5 * xrange) # xmax - right
bbox_new[2] <- bbox_new[2] + (0.4 * yrange) # ymin - bottom
bbox_new[4] <- bbox_new[4] - (0.5 * yrange) # ymax - top

lev_crop <- lev |>
  sf::st_crop(bbox_new)
```

```{r readMire}
#| code-fold: true
#| code-summary: "Read mire data"
#| eval: false

# I took the gdb file in the same folder and opened it in arcgis pro
# and exported a section of it as geoTIFF
# Raster GBD is not readable in R with GDAL <3.7
path <- "P:/41201785_okologisk_tilstand_2022_2023/data/Myrmodell/myrmodell_levanger.tif"
mire90 <- stars::read_stars(path) |>
  st_crop(lev_bb) |> 
  setNames("prob") |>
  mutate(prob = case_when(
    prob > 900 ~ 1,
    TRUE ~ NA
  ))
stars::write_stars(mire90, "data/mire_levanger_reclassified90.tif")
saveRDS(mire90, "data/mire_levanger_reclassified90.rds")

mire70 <- stars::read_stars(path) |>
  st_crop(lev_bb) |> 
  setNames("prob") |>
  mutate(prob = case_when(
    prob > 700 ~ 1,
    TRUE ~ NA
  ))
stars::write_stars(mire70, "data/mire_levanger_reclassified70.tif")
saveRDS(mire70, "data/mire_levanger_reclassified70.rds")

mire50 <- stars::read_stars(path) |>
  st_crop(lev_bb) |> 
  setNames("prob") |>
  mutate(prob = case_when(
    prob > 500 ~ 1,
    TRUE ~ NA
  ))
stars::write_stars(mire50, "data/mire_levanger_reclassified50.tif")
saveRDS(mire50, "data/mire_levanger_reclassified50.rds")

mire10 <- stars::read_stars(path) |>
  st_crop(lev_bb) |> 
  setNames("prob") |>
  mutate(prob = case_when(
    prob > 100 ~ 1,
    TRUE ~ NA
  ))
stars::write_stars(mire10, "data/mire_levanger_reclassified10.tif")
saveRDS(mire10, "data/mire_levanger_reclassified10.rds")

```

```{r}
#| code-fold: true
#| code-summary: "Read mire data"

#90% probability
mire90 <- readRDS("data/mire_levanger_reclassified90.rds")
mire90_crop <- mire90 |>
  st_crop(st_bbox(lev_crop))

#10% probability
mire10 <- readRDS("data/mire_levanger_reclassified10.rds")
mire10_crop <- mire10 |>
  st_crop(st_bbox(lev_crop))


```

```{r fig-map2}
#| code-fold: true
#| code-summary: "Create map"
#| cache: true
#| fig-cap: |
#|   "Zoomed in version of the previsous map showing systematic trenching,
#|   but also more sporadic trenches that might be errors in the model.
#|   The red areas are open mires with 10% probability.
#|   Yellow areas are mires with 90% probability. From areal photos, the 10% probability seem to match best.
#|   Note in any case that most of the trenches are located in 
#|   other nature types, mosty forests."


ggplot() + 
  geom_sf(data = lev_crop,
          fill = "purple",
          color = "purple") +
  geom_stars(data = mire10_crop,
             downsample = 0,
             fill = "red",
             na.action = na.omit,
             alpha=.7)+
  geom_stars(data = mire90_crop,
             downsample = 0,
             fill = "yellow",
             na.action = na.omit,
             alpha=.7)+
  theme_bw()

```

The trenches model originally results in a raster with a continuous probability value for the occurrence of a trench in each 1 ùñ∑ 1 m cell. What I show above (@fig-map1, @fig-map2) is a version of this data where a threshold value of 90% for the probabilities turn it into presence-absence data in the shape of polygons.

```{r savefiles}
#| include: false
save(
  mire10_crop,
  lev_crop,
  file = "data/study-area-files.RData"
)

```
